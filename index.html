<!DOCTYPE html>
<html>
	<head>
		<title>PyPandora</title>
		<link id="favicon" href="#" rel="shortcut icon" />
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script type="text/javascript" src="http://jplayer.org/latest/js/jquery.jplayer.min.js"></script>
		
		<style type="text/css">
			#main_container {
				width:500px;
			}
			
			#album_art_container {				
				-webkit-box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 1);
				-moz-box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 1);
				box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 1);
				position:relative;
				width:500px;
				height:500px;
			}
			#album_art {
				width:500px;
				height:500px;
			}
			
			#overlay {
				background-color:rgba(0,0,0,.9);
				display:none;
				text-align:center;
				position:absolute;
				top:0;
				right:0;
				color:white;
				width:200px;
				height:100px;
				line-height:100px;
				font-size:14px;
				z-index:30;
				-webkit-box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 1);
				-moz-box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 1);
				box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 1);
				font-family:monospace;
			}
			
			html {
				background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAkCAMAAAAw96PuAAAAMFBMVEUbGxsaGhoiIiIcHBwVFRUYGBggICAeHh4WFhYfHx8XFxcUFBQdHR0ZGRkhISESEhKy7ZvJAAABQUlEQVR42l1TUZLFIAiDRQpS3Xf/2+6Ugjw2X6nTxMgEAPxJ0IAXzFeeCcKFCoHJ9pKbKI5wCNBUjE+S4dR4pkhRABbcEBDUV5cWW6ebG597FF9dYMBy80zofq4LsM1MWGGNXRcWizJhhaXbKuaWr4QJ28UfiwDveQUIsbjBGcta9AJYwCgwt7b7ckKiDP/yoZ4JsU5YNCqf0zYhWs+L7fyiHLqA+UtpjXi8+4XOgfG8Suh+bUJBM6H7gYGdCclJeGsAGaimJXm/8VUThAtGr0cWJGmrR5i0gkirh8AIXRWkFTj87kdXlY4CVz1S1yotbSFC1xNPhQQNphOzEq+vjmFxXZAw/K0t/OKW+foK9QWr+2qF2oLto6sJ9QUbVaxaoV4Pdp30FaJWj9RVpavATrfCx3U9seiuhQBGPZBTYC38AccDDZOEuQAKAAAAAElFTkSuQmCC);
				height:100%;
			}
			body {
				background:-webkit-gradient(radial, 49% 30%, 0, 49% 50%, 450, from(rgba(255,255,255,.4)), to(rgba(0,0,0,0)));
				height:100%;
				margin:0;
				font-family: sans-serif;
			}
			
			#credits {
				font-family: sans-serif;
				font-size:10px;
				color:white;
				position:absolute;
				bottom:20px;
				right:20px;
			}
			
			#credits a {
				color: #9ee2ff;
			}
			
			#header {
				font-size:20px;
				color:white;
				padding-bottom:15px;
				text-shadow: 2px 2px 3px #000;
			}
			
			#footer {
				font-size:16px;
				color:white;
				text-shadow: 2px 2px 3px #000;
				font-variant:small-caps;
			}
			
			.player_button {
				background-color: rgba(0,0,0,.3);
				color:white;
				font-size:20px;
				cursor:pointer;
				border-radius:5px;
				margin-bottom:10px;
				text-align:center;
				width:50px;
				padding:10px 0;
			}
			.player_button:hover {
				background-color: rgba(0,0,0,.6);
			}
			
			
			.ui-slider-vertical {
				width:35px;
			}
			
			.ui-widget-content {
				border:0;
				background-color:rgba(0,0,0,.3);
				border-radius:5px;
			}
			
			.ui-slider {
				position:relative;
				text-align:left;
			}
			
			.ui-slider-vertical .ui-slider-range-min {
				bottom:0;
			}
			
			.ui-slider-vertical .ui-slider-range {
				left:0;
				width:100%;
			}
			
			.ui-slider .ui-slider-range {
				position: absolute;
				z-index: 1;
				font-size: .7em;
				display: block;
				border: 0;
				background-position: 0 0;
			}
			
			.ui-widget-header {
				border:0;
				background-color:rgba(0,0,0,.3);
				font-weight: bold;
			}
			
			.purchase_link img {
				-webkit-box-shadow: 2px 2px 3px #000;
				-moz-box-shadow: 2px 2px 3px #000;
				box-shadow: 2px 2px 3px #000;
			}
			
			.purchase_link {
				text-decoration:none;
			}
			
			.album_art {
				width:500px;
				height:500px;
				background-color:rgba(0,0,0,.5);
				background-size:100% 100%;
				position:absolute;
			}
			
			#volume {
				height:500px;
				position:absolute;
				left:-55px;
				bottom:0px; 
			}
		</style>
	</head>
	
    <body>
    	<div id="jquery_jplayer"></div>

		<div id="main_container">
			<div id="header" style="display:none;">
				<span id="track-title"></span> - <span id="track-artist"></span>
			
				<span style="padding-left:10px;">
					<a class="purchase_link" id="purchase_itunes" title="purchase on itunes" target="_blank" href="#">
						<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABhUlEQVQ4jZWTP6vqQBDFf5td4SZdRGxsRKwsVbC20O/ox/AjWEZsRLRRUEQiKPin0bDZTV7lvhe818ubbmfnHM6cmRGj0Sjnl0jTFCEESqm3P+8TMM9zsiyj1WpRr9cxxvwfgbWWbrdLv98nDEOyLHuredNkrcUYg7WWcrlMu90mjmPm87lTJYT4nsAYQxiGNBoNAC6XC8vlkjRN6XQ6XK9XdrtdgUT9C67VagwGA4IgcDmttXsDTKdTZrOZM1S9ZCml6PV6hWKlVMH5x+PBfr/H8/5a570IgiCgUql88pTVasXxeHwnAArJn0JrTZ4X18ahXs5/imazie/7hXF6AEIIns8np9PpI0G1WmU4HCKldEocgTGG9Xr9axtfX1+FNlwLSik2mw1xHP8IzrKMKIowxrg9cARCCKy1TCYTzuczWmu22y2LxYL7/Y7WmiiKOBwOhdEWNlFKye12Yzweo5QiSRKstfi+j+d5JEmClLKg6u0WpJTuHoQQlEol0jQlz/NvR/0HgUTC+duFiXUAAAAASUVORK5CYII=" />
					</a>
					<a class="purchase_link" id="purchase_amazon" title="purchase on amazon" target="_blank" href="#">
						<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAByklEQVQ4jY2TP2hTURjFf09zM9UQcGmID9xEFEyyCTq1b6uLxuCS1e5Fgotu4mBdzAOnLA7BpU0HR6Gb/3hTEEwyGBzynjWgvjyl0IDH4aVpmryKB+5wv8t3vnPuuRdJaUlPJQ30/xhMetKWpMfAfWbQ6/VoNBp87vexLIsba2tUq1USsImkYJba8zydNkapuVWr1ZKUBEgKZyt319eVMkarjqNOpzPdn7PtJILQkhQCmUNNQRDg+z5hGDKKIprNJq1WC4DxwcG8hdGCgm63q0KptGAhZUyiggWC25WKUsaoUCrJ933VXfefBKfmNR3KLZfL5HI52u329CyKosUc5hUUisXpxFXHOZZI3XVPsPDbn1Y8z1PetpUyRnnbVt11Va5UtOI4ir4H+tN5IX3YiNc0hVeXMlzbhuyFpMdyhN1bsHQe0ln49BDuaJLC4LX0Eun9hhT58zKP8Gsg9bekHx1p6+zcO/jSgnc340nZ67DsgMmAAMuCvV3Y24Gr23F9+AauPBhZkgJgGYChBx8fwbeduJFJP8DSRSg+g/wqjCdpmDNfLUlPgHvHvP7swvAtjMOYIXsZ8itJt7KJ4u/8XNL+yeYXsD/pSf8FnD4v3ctAsWIAAAAASUVORK5CYII=" />
					</a>
				</span>
			</div>
			
			<div style="position:relative; height:500px;">				
				<div id="volume" style="display:none;"></div>
				
				<div id="controls" style="position:absolute; right: -67px; display:none;">
					<div id="like" class="player_button">&#9650;</div>
					<div class="player_button">&#9660;</div>
					<div id="next" class="player_button">&#9654;&#9654;</div>
				</div>
				
		        <div id="album_art_container">
		        	<div id="overlay"></div>
		        	<div class="album_art" id="current_album_art" style="z-index:20;"></div>
		        	<div class="album_art" id="next_album_art" style="z-index:10;"></div>
		        </div>
	        </div>
	        
	        <div id="footer" style="padding-top:15px;">
		        <div style="float:left;">
		        	Stations <select id="stations" style="margin-left:20px;"></select>
		        </div>
	        </div>
        </div>
        
		<div id="credits">
			created by <a href="mailto:andrew.robert.moffat@gmail.com">Andrew Moffat</a>
		</div>
        
        <script type="text/javascript">
        
        	var lp_cursor = "";
        	var current_song = null;
        	var current_station = null;
        	var overlay_interval = null;
        
        	function long_poll() {
        		$.get("/events", {cursor: lp_cursor}, function(data) {
        			
        		});
        	}
        
        	function control(method, data, success) {
        		$.get("/control/" + method, data, success);
        	}
        	
        	function song_info() {
        		$.get("/current_song_info", function(data) {
        			$("#header").show();
        			$("#volume").show();
        			$("#controls").show();
        			
        			console.log(data);
        			
        			if (current_song != data.id) {
	        			current_song = data.id;
	        			
	        			if (data.purchase_amazon) {$("#purchase_amazon").attr("href", data.purchase_amazon).show();}
	        			else {$("#purchase_amazon").hide();}
	        			
	        			if (data.purchase_amazon) {$("#purchase_itunes").attr("href", data.purchase_itunes).show();}
	        			else {$("#purchase_itunes").hide();}
	        			
	        			$("#track-artist").text(data.artist);
	        			$("#track-title").text(data.title);        	
	        			
	        			var title = data.title + " by " + data.artist;
	        			$("head title").text(title);
	        			
	        			
	        			/* what this does is sets the new album image to the
	        			background img, then fades out the foreground, then
	        			sets the hidden foreground to the current background
	        			then shows it again */	        			
	        			var album_art = new Image();
	        			album_art.src = data.album_art;
	        			$(album_art).load(function() {
	        				$("#next_album_art").css("background-image", "url("+data.album_art+")");
	        				$("#current_album_art").fadeOut("fast", function() {
	        					$(this).css("background-image", "url("+data.album_art+")").show();
	        				});
	        			});
        			}        			
        		})
        	}
        	
        	function restart_music() {
        		$("#jquery_jplayer").jPlayer("clearMedia").jPlayer("setMedia", {mp3:"/m"}).jPlayer("play");
        	}
        	
        	function change_station(id) {
        		overlay_show("Changing station");
        		control("change_station", {"station_id": id});
        		current_station = id;
        		restart_music();
        	}
        	
        	function change_song() {
       			overlay_show("Changing song");
       			control("next_song");
       			restart_music();        		
        	}
        	
        	
        	function update_overlay() {
        		var spin = "|/-\\";
        		var text = $("#overlay").text();
        		var cur_spin_pos = text.lastIndexOf(" ") + 1;
        		
        		var cur_spin = text[cur_spin_pos];
        		var next_spin = spin[spin.indexOf(cur_spin)+1];
        		if (typeof(next_spin) == "undefined") {next_spin = spin[0];}
        		//console.log(cur_spin, next_spin);
        		text = text.replace(cur_spin, next_spin);
        		$("#overlay").text(text);
        	}
        	function overlay_show(msg) {
        		$("#overlay").text(msg + " |").fadeIn("fast");
        		overlay_interval = setInterval(update_overlay, 100);
        	}
        	function overlay_hide() {
        		$("#overlay").fadeOut("fast");
        		clearInterval(overlay_interval);
        	}
        	
        	function set_volume(level, set_slider) {
        		$("#jquery_jplayer").jPlayer("volume", level / 100);
        		if (set_slider) {$("#volume").slider("value", level);}
        	}
        	
        	function account_info() {
        		$.get("/account_info", function(data) {
        			console.log(data);
        			
        			
        			var select = $("#stations");
        			var id,name,option;
        			
        			select.find('option').remove();
        			for (var i=0; i<data.stations.length; i++) {
        				id = data.stations[i][0];
        				name = data.stations[i][1];
        				select.append($("<option>"+name+"</option>").val(id));
        			}
        			
        			select.val(data.current_station);
        			current_station = data.current_station;
        			set_volume(data.volume, true);
        		});
        	}
        	
        	
        	$(function() {      
        		$("#overlay").css({
        			position:"absolute",
        			left: (500 - $("#overlay").outerWidth())/2,
        			top: (500 - $("#overlay").outerHeight())/2,
        		});
        		
        		$(window).resize(function(){
					$('#main_container').css({
						position:'absolute',
						left: ($(window).width() - $('#main_container').outerWidth())/2,
						top: ($(window).height() - $('#main_container').outerHeight())/2.5
					 });
				});
        		$(window).resize();
        	
        		$("#jquery_jplayer").jPlayer({
        			solution: "html,flash",
        			ready: function () {
        				$(this).jPlayer("setMedia", {mp3:"/m"}).jPlayer("play");
        			},
        			preload: "none",
        			swfPath: "http://jplayer.org/latest/js/",
        			supplied: "mp3",
        			wmode: "window"
        		});
        		
        		
        		var load_trigger = $.jPlayer.event.canplay;
        		if ($.browser.msie || $.browser.opera) {load_trigger = $.jPlayer.event.loadstart;}        		
        		$("#jquery_jplayer").bind(load_trigger, function() {
    				overlay_hide();
    				song_info();
        		});

        		
        		$("#next").click(change_song);        		
        		$("#like").click(song_info);
        		
        		$("#stations").click(function() {
        			if (current_station != $(this).val()) {
        				change_station($(this).val());
        			}
        		})
        		
        		
        		$("#volume").slider({
        			orientation: "vertical",
        			range: "min",
        			min: 0,
        			max: 100,
        			value: 0,
        			animate: true,
        			slide: function(event, ui) {
        				set_volume(ui.value, false);
        			},
        			change: function(event, ui) {
        				control("volume", {level: ui.value});
        			}
        		});
        		
        		account_info();
        		overlay_show("Buffering")
        	});
        </script>
        
    </body>
</html>